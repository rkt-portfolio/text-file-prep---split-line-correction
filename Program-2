%LET PATH = \\DATA PREPARATION;
LIBNAME SASDATA "&PATH.\SASDATA";

* THE FOLLOWING CODE CORRECTS THE SPLIT LINES AND APPENDS THEM AT THE END OF THE GOOD DATA;

%MACRO READIN(IN,OUT,DATASTART);
DATA &OUT.;
  	INFILE "&PATH.\RAWDATA\&IN."  TRUNCOVER LRECL=32767 FIRSTOBS=1;
	INPUT TOTAL_TEXT $1000.;
	TOTAL_TEXT = COMPRESS(TOTAL_TEXT,'"');
	TOTAL_TEXT = STRIP(TOTAL_TEXT);
	COUNT_DELIM = COUNT(TOTAL_TEXT,'|');
	LINE_CNT = _N_;
RUN;
%MEND;
%READIN (GLTRANS_2014_DT_012615.txt, TEMP_JE01);
/*%READIN (GLTRANS_2015_DT_P1.txt, TEMP_JE02);*/


/*SEGREGATING THE RECORDS WITH LINES WITH < 51 DELIMITERS */

DATA TEMP_JE;
SET TEMP_JE01;
RUN;

DATA GOOD BAD1 BAD2 ;
	SET TEMP_JE;
	IF COUNT_DELIM = 19 THEN OUTPUT GOOD;
	ELSE IF COUNT_DELIM LT 19 THEN OUTPUT BAD1;
	ELSE OUTPUT BAD2;
RUN;

/*FIXING THE LINES WITH  < 19 DELIMITERS & >19 DELIMITERS */

DATA BAD1_REPAIR;
	LENGTH TOTAL_TEXT1 $1000.;
SET BAD1;
	RETAIN TOTAL_TEXT1 COUNT1;
	TOTAL_TEXT1 = COMPRESS(TRIM(TOTAL_TEXT1)||TRIM(TOTAL_TEXT),'"');
	COUNT1 = SUM(COUNT1,COUNT_DELIM);
	IF (COUNT1 EQ 19) THEN DO;
		OUTPUT;
		TOTAL_TEXT1 = "";
		COUNT1 = 0;
	END;
		DROP TOTAL_TEXT;
		RENAME TOTAL_TEXT1 = TOTAL_TEXT;
RUN;

DATA BAD1_REPAIR_1(KEEP = TOTAL_TEXT);
	SET BAD1_REPAIR;
	TOTAL_TEXT =COMPRESS(TOTAL_TEXT,'09'X); /* COMPRESSING TAB CHARACTERS */
RUN;

DATA JE_REPAIRED;
	SET GOOD(KEEP = TOTAL_TEXT) BAD1_REPAIR_1(KEEP = TOTAL_TEXT) ;
RUN;

/*EXPORTING THE FINAL REPAIRED FILE INTO PIPE DELIMITED TXT.*/

PROC EXPORT DATA= WORK.JE_REPAIRED 
            OUTFILE= "&PATH.\RAWDATA\JE_REPAIRED_FY14.txt" 
            DBMS=DLM REPLACE;
     DELIMITER='5E'x; 
RUN;

